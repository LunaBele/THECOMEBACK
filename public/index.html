<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grow A Garden Notifier</title>
</head>
<body>
  <h1>Grow A Garden Notifier</h1>
  <form id="uidForm">
    <label>Enter Facebook UID:</label>
    <input type="text" name="uid" required>
    <button type="submit">Check</button>
  </form>

  <div id="result"></div>
  <div id="uid-display"></div>

  <form id="preferencesForm" style="display:none;">
    <h3 id="welcomeText"></h3>

    <label>Seeds:</label><br>
    <select name="seeds" multiple>
      <option>Carrot</option>
      <option>Strawberry</option>
      <option>Blueberry</option>
      <option>Orange Tulip</option>
      <option>Tomato</option>
      <option>Daffodil</option>
      <option>Corn</option>
      <option>Watermelon</option>
      <option>Pumpkin</option>
      <option>Apple</option>
      <option>Bamboo</option>
      <option>Coconut</option>
      <option>Cactus</option>
      <option>Dragon Fruit</option>
      <option>Mango</option>
      <option>Grape</option>
      <option>Mushroom</option>
      <option>Pepper</option>
      <option>Cacao</option>
      <option>Beanstalk</option>
      <option>Ember Lily</option>
      <option>Sugar Apple</option>
      <option>Burning Bud</option>
      <option>Giant Pinecone</option>
      <option>Elder Strawberry</option>
      <option>Romanesco</option>
    </select><br><br>

    <label>Gear:</label><br>
    <select name="gear" multiple>
      <option>Watering Can</option>
      <option>Trowel</option>
      <option>Trading Ticket</option>
      <option>Recall Wrench</option>
      <option>Basic Sprinkler</option>
      <option>Advanced Sprinkler</option>
      <option>Medium Toy</option>
      <option>Medium Treat</option>
      <option>Godly Sprinkler</option>
      <option>Magnifying Glass</option>
      <option>Master Sprinkler</option>
      <option>Cleaning Spray</option>
      <option>Cleansing Pet Shard</option>
      <option>Favorite Tool</option>
      <option>Harvest Tool</option>
      <option>Friendship Pot</option>
      <option>Grandmaster Sprinkler</option>
      <option>Level Up Lollipop</option>
    </select><br><br>

    <label>Eggs:</label><br>
    <select name="eggs" multiple>
      <option>Common Egg</option>
      <option>Uncommon Egg</option>
      <option>Rare Egg</option>
      <option>Legendary Egg</option>
      <option>Mythical Egg</option>
      <option>Bug Egg</option>
    </select><br><br>

    <label>Traveling Merchant:</label><br>
    <select name="travelingmerchant" multiple>
      <option>Cauliflower</option>
      <option>Special Seed</option>
      <option>Mystery Box</option>
      <option>Rare Fertilizer</option>
      <option>Golden Carrot</option>
      <option>Starfruit</option>
    </select><br><br>

    <button type="submit">Save Preferences</button>
  </form>

  <script>
    document.getElementById("uidForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const uid = e.target.uid.value.trim();

      if (!uid) {
        document.getElementById("result").innerText = "Please enter a UID.";
        return;
      }

      try {
        const res = await fetch("/check-uid", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ uid })
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById("welcomeText").innerText = `Hello, ${data.name}! (${data.mode === "edit" ? "Edit Mode" : "New"})`;
          document.getElementById("preferencesForm").style.display = "block";
          document.getElementById("preferencesForm").dataset.uid = uid;
          document.getElementById("uid-display").innerText = `Your UID: ${uid} (click to copy)`;
          document.getElementById("uid-display").onclick = () => {
            navigator.clipboard.writeText(uid).then(() => {
              document.getElementById("result").innerText = "UID copied to clipboard!";
              setTimeout(() => {
                document.getElementById("result").innerText = "";
              }, 3000);
            });
          };
          document.getElementById("result").innerText = `UID validated! Name: ${data.name}`;

          // Pre-fill if edit mode
          if (data.mode === "edit") {
            const seeds = data.seeds || [];
            const gear = data.gear || [];
            const eggs = data.eggs || [];
            const travelingmerchant = data.travelingmerchant || [];
            document.querySelectorAll("select[name='seeds'] option").forEach(opt => {
              if (seeds.includes(opt.value)) opt.selected = true;
            });
            document.querySelectorAll("select[name='gear'] option").forEach(opt => {
              if (gear.includes(opt.value)) opt.selected = true;
            });
            document.querySelectorAll("select[name='eggs'] option").forEach(opt => {
              if (eggs.includes(opt.value)) opt.selected = true;
            });
            document.querySelectorAll("select[name='travelingmerchant'] option").forEach(opt => {
              if (travelingmerchant.includes(opt.value)) opt.selected = true;
            });
          }
        } else {
          document.getElementById("result").innerText = data.message;
        }
      } catch (err) {
        document.getElementById("result").innerText = "Error validating UID. Please try again.";
      }
    });

    document.getElementById("preferencesForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const uid = e.target.dataset.uid;
      const name = document.getElementById("welcomeText").innerText.split(",")[1].split("!")[0].trim();
      const seeds = Array.from(e.target.seeds.selectedOptions).map(o => o.value);
      const gear = Array.from(e.target.gear.selectedOptions).map(o => o.value);
      const eggs = Array.from(e.target.eggs.selectedOptions).map(o => o.value);
      const travelingmerchant = Array.from(e.target.travelingmerchant.selectedOptions).map(o => o.value);

      if (seeds.length === 0 && gear.length === 0 && eggs.length === 0 && travelingmerchant.length === 0) {
        document.getElementById("result").innerText = "Please select at least one preference.";
        return;
      }

      try {
        const res = await fetch("/save-preferences", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ uid, name, seeds, gear, eggs, travelingmerchant })
        });
        const data = await res.json();
        document.getElementById("result").innerText = data.message;
      } catch (err) {
        document.getElementById("result").innerText = "Error saving preferences. Please try again.";
      }
    });
  </script>
</body>
</html>